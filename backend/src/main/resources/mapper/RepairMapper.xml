<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dormitory.management.mapper.RepairMapper">

    <!-- 结果映射 -->
    <resultMap id="RepairVOMap" type="com.dormitory.management.vo.RepairVO">
        <id column="id" property="id"/>
        <result column="room_id" property="roomId"/>
        <result column="room_no" property="roomNo"/>
        <result column="building_name" property="buildingName"/>
        <result column="student_id" property="studentId"/>
        <result column="student_name" property="studentName"/>
        <result column="title" property="title"/>
        <result column="description" property="description"/>
        <result column="type" property="type"/>
        <result column="priority" property="priority"/>
        <result column="status" property="status"/>
        <result column="report_time" property="reportTime"/>
        <result column="handle_time" property="handleTime"/>
        <result column="complete_time" property="completeTime"/>
        <result column="handler_id" property="handlerId"/>
        <result column="handler_name" property="handlerName"/>
        <result column="handle_remark" property="handleRemark"/>
        <result column="contact_phone" property="contactPhone"/>
        <result column="create_time" property="createTime"/>
        <result column="update_time" property="updateTime"/>
    </resultMap>

    <!-- 分页查询报修列表 -->
    <select id="selectRepairPage" resultMap="RepairVOMap">
        SELECT
            r.id,
            r.room_id,
            r.room_no,
            r.building_name,
            r.student_id,
            r.student_name,
            r.title,
            r.description,
            r.type,
            r.priority,
            r.status,
            r.report_time,
            r.handle_time,
            r.complete_time,
            r.handler_id,
            r.handler_name,
            r.handle_remark,
            r.contact_phone,
            r.create_time,
            r.update_time
        FROM repair r
        WHERE r.deleted = 0
        <if test="params.roomNo != null and params.roomNo != ''">
            AND r.room_no LIKE CONCAT('%', #{params.roomNo}, '%')
        </if>
        <if test="params.roomId != null">
            AND r.room_id = #{params.roomId}
        </if>
        <if test="params.buildingId != null">
            AND r.building_name IN (
                SELECT building_name FROM dormitory WHERE building_id = #{params.buildingId}
            )
        </if>
        <if test="params.studentId != null">
            AND r.student_id = #{params.studentId}
        </if>
        <if test="params.studentName != null and params.studentName != ''">
            AND r.student_name LIKE CONCAT('%', #{params.studentName}, '%')
        </if>
        <if test="params.type != null and params.type != ''">
            AND r.type = #{params.type}
        </if>
        <if test="params.status != null">
            AND r.status = #{params.status}
        </if>
        <if test="params.priority != null">
            AND r.priority = #{params.priority}
        </if>
        <if test="params.startDate != null and params.startDate != ''">
            AND DATE(r.report_time) >= #{params.startDate}
        </if>
        <if test="params.endDate != null and params.endDate != ''">
            AND DATE(r.report_time) &lt;= #{params.endDate}
        </if>
        ORDER BY r.priority DESC, r.report_time DESC
    </select>

    <!-- 根据ID查询报修详情 -->
    <select id="selectRepairById" resultMap="RepairVOMap">
        SELECT
            r.id,
            r.room_id,
            r.room_no,
            r.building_name,
            r.student_id,
            r.student_name,
            r.title,
            r.description,
            r.type,
            r.priority,
            r.status,
            r.report_time,
            r.handle_time,
            r.complete_time,
            r.handler_id,
            r.handler_name,
            r.handle_remark,
            r.contact_phone,
            r.create_time,
            r.update_time
        FROM repair r
        WHERE r.id = #{id} AND r.deleted = 0
    </select>

</mapper>